name: ğŸš€ Deploy FastAPI Backend with Docker Compose

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    environment: production

    steps:
      - name: ğŸ§¹ Cleanup all __pycache__ folders before checkout
        run: |
          sudo find /home/Tabchny/actions-runner/_work/Petly_App -name '__pycache__' -type d -exec sudo rm -rf {} + || true
          sudo find /home/Tabchny/actions-runner/_work/Petly_App -name '*.pyc' -exec sudo rm -f {} + || true

      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Check BACK_ENV secret availability
        run: |
          if [ -z "${{ secrets.BACK_ENV }}" ]; then
            echo "âŒ ERROR: BACK_ENV secret is not set in GitHub repository settings!"
            echo "Please add BACK_ENV secret in repository Settings > Secrets and variables > Actions"
            exit 1
          else
            echo "âœ… BACK_ENV secret is available"
          fi

      - name: ğŸ“„ Create .env file
        run: |
          cd back-project
          echo "ğŸ”§ Creating .env file from BACK_ENV secret..."
          echo "${{ secrets.BACK_ENV }}" > .env
          
          echo "ğŸ“ Checking .env file was created:"
          if [ -f .env ]; then
            echo "âœ… .env file exists"
            echo "ğŸ“ File size: $(wc -c < .env) bytes"
            echo "ğŸ“„ .env file contents (masked):"
            sed 's/=.*/=***MASKED***/' .env
          else
            echo "âŒ ERROR: .env file was not created!"
            exit 1
          fi

      - name: ğŸ³ Stop existing containers
        run: |
          cd back-project
          echo "ğŸ›‘ Stopping existing containers..."
          sudo docker compose down --remove-orphans || true
          sudo docker system prune -f || true

      - name: ğŸ§¹ Fix permissions after stopping containers
        run: |
          sudo chown -R $USER:$USER /home/Tabchny/actions-runner/_work/Petly_App

      - name: ğŸ”¨ Build and start containers
        run: |
          cd back-project
          echo "ğŸ—ï¸ Building and starting containers..."
          sudo docker compose up -d --build --force-recreate
          
          echo "â³ Waiting for containers to start..."
          sleep 10

      - name: ğŸ” Verify deployment
        run: |
          cd back-project
          echo "ğŸ³ Running containers:"
          sudo docker compose ps
          
          echo "ğŸ“Š Container health status:"
          sudo docker compose top
          
          echo "ğŸ“ Backend logs (last 20 lines):"
          sudo docker compose logs --tail=20 backend
          
          echo "ğŸŒ Testing backend health:"
          curl -f http://localhost:8000/docs || echo "âš ï¸ Backend health check failed"

      - name: ğŸš¨ Show errors if deployment failed
        if: failure()
        run: |
          cd back-project
          echo "ğŸ’¥ Deployment failed! Showing debug information..."
          echo "ğŸ“ All container logs:"
          sudo docker compose logs
          
          echo "ğŸ³ Container status:"
          sudo docker compose ps -a
          
          echo "ğŸ’¾ Docker system info:"
          sudo docker system df
