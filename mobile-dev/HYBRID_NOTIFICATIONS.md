# Гибридный подход к уведомлениям для виртуальных активностей

## Обзор

Гибридный подход решает проблему создания уведомлений для повторяющихся виртуальных активностей, используя разные стратегии в зависимости от типа повтора.

## Принципы работы

### 1. Стандартные повторы (интервал = 1)
- **Ежедневно, еженедельно, ежемесячно, ежегодно**
- Использует встроенные триггеры Expo Notifications
- Создается **одно уведомление** с соответствующим триггером
- **Надежно и эффективно**

```typescript
// Пример: ежедневное кормление в 9:00
{
  type: Notifications.SchedulableTriggerInputTypes.DAILY,
  hour: 9,
  minute: 0,
}
```

### 2. Кастомные интервалы (интервал > 1)
- **Каждые 3 дня, каждые 2 недели, каждые 6 месяцев**
- Создается **до 7 отдельных уведомлений** для ближайших дат
- Каждое уведомление имеет точную дату и время
- **Background task** обновляет уведомления каждые несколько дней

```typescript
// Пример: кормление каждые 3 дня
// Создаются уведомления на:
// - 15.01.2024 9:00
// - 18.01.2024 9:00  
// - 21.01.2024 9:00
// - 24.01.2024 9:00
// - 27.01.2024 9:00
// - 30.01.2024 9:00
// - 02.02.2024 9:00
```

## Реализация

### Ключевые функции

#### `scheduleVirtualActivityNotifications()`
```typescript
async scheduleVirtualActivityNotifications(
  activity: ActivityRecord, 
  petName?: string
): Promise<string[]>
```

**Логика:**
1. Проверяет тип повтора
2. Для стандартных повторов → создает одно уведомление
3. Для кастомных интервалов → создает до 7 уведомлений
4. Возвращает массив ID уведомлений

#### `cancelVirtualActivityNotifications()`
```typescript
async cancelVirtualActivityNotifications(activity: ActivityRecord): Promise<void>
```

**Логика:**
1. Отменяет основное уведомление
2. Для кастомных интервалов → отменяет все виртуальные уведомления

#### `updateVirtualActivityNotifications()`
```typescript
async updateVirtualActivityNotifications(): Promise<void>
```

**Логика:**
1. Проверяет все запланированные уведомления
2. Находит устаревшие уведомления для кастомных интервалов
3. Создает новые уведомления для следующих дат
4. Вызывается через background task

## Преимущества

### ✅ Надежность
- Стандартные повторы используют проверенные механизмы Expo
- Кастомные интервалы имеют резервные уведомления

### ✅ Производительность
- Минимум уведомлений в системе (максимум 7 для кастомных интервалов)
- Эффективное использование ресурсов

### ✅ Гибкость
- Поддержка любых интервалов повторов
- Автоматическое обновление через background task

### ✅ Пользовательский опыт
- Точные уведомления для каждой даты
- Понятная логика работы

## Ограничения

### ⚠️ Background Task
- Зависимость от работы background task
- Может не сработать на некоторых устройствах

### ⚠️ Лимиты уведомлений
- Максимум 7 уведомлений для кастомных интервалов
- Может потребоваться обновление для длинных серий

### ⚠️ Сложность отладки
- Две разные системы уведомлений
- Сложность диагностики проблем

## Использование

### Создание активности с повторами
```typescript
const repeatResult = await createActivityWithRepeats(activityRecord);
// Автоматически создает уведомления с гибридным подходом
```

### Обновление активности
```typescript
const updateResult = await updateActivityWithRepeats(activityId, updates, originalActivity);
// Автоматически пересоздает уведомления
```

### Отмена уведомлений
```typescript
await notificationService.cancelVirtualActivityNotifications(activity);
// Отменяет все связанные уведомления
```

## Мониторинг

### Логи
- Все операции логируются с эмодзи для легкой идентификации
- Отдельные логи для стандартных и кастомных интервалов

### Отладка
```typescript
// Получить информацию о запланированных уведомлениях
const info = await notificationService.getScheduledNotificationsInfo();
console.log(`Scheduled: ${info.count} notifications`);
```

## Будущие улучшения

1. **Адаптивное количество уведомлений** - больше для активных пользователей
2. **Умные триггеры** - анализ поведения пользователя
3. **Кэширование** - оптимизация производительности
4. **Аналитика** - отслеживание эффективности уведомлений 